- subscription_status = @brand.subscription&.status
- checkout_redirect_path = request.original_url
.row.my-3
  .col-6.col-lg-10
    %h3 Brand
  .col-6.col-lg-2.d-flex.justify-content-end
    %h5.text-muted= @brand.screen_name
  %hr.border-2.border-top
  .row.mb-3
    .col-lg-6.mb-5
      %h5 Account Settings
      %hr.border-2.border-top
      = render partial: 'shared/accounts', locals: { providers: BrandAccount.providers.keys, model: @brand }
    .col-lg-6
      %h5 Brand Settings
      %hr.border-2.border-top
      .row.mb-3
        .col-12
          %h6.mb-3 Users outside brand
          %hr.border-2.border-top
          = form_with url: brand_users_path(@brand), method: :post, class: 'form-inline' do |add_user_form|
            .row
              .col-8.col-lg-10
                = add_user_form.select :user_id, options_for_select(add_users_dropdown_options_for),
                  { include_blank: 'Select user' }, required: true, class: 'custom-select form-control', id: 'add-user'
              .col-4.col-lg-2
                = add_user_form.submit 'Add', class: 'btn form-control btn-primary'
      .row.mt-5
        .col-12
          %h6.mb-3 Users in Brand
          %hr.border-2.border-top
          .list-group
            - @brand_users.each do |user|
              .list-group-item
                .row
                  .col-8
                    %p.mb-0.fw-bold= user.name
                  .col-4.d-flex.justify-content-end
                    = link_to brand_user_path(@brand, user),
                      'data-turbo-method' => :delete, 'data-turbo-frame' => :_top do
                      = bi_icon('trash3-fill')
          .row.mt-3
            .d-flex.justify-content-center
              != pagy_bootstrap_nav(@pagy)
      .row.mt-5
        .col-12
          %h6.mb-3 Brand Domain
          %hr.border-2.border-top
          = form_with model: @brand, method: :patch, class: 'form-inline' do |update_brand_form|
            .row
              .col-8.col-lg-10
                = update_brand_form.text_field :domain, required: true, placeholder: 'domain.com', class: 'form-control'
              .col-4.col-lg-2
                = update_brand_form.submit 'Update', name: nil, class: 'btn form-control btn-primary'
      .row.mt-5
        .col-12
          - unless Flipper.enabled?(:disable_subscriptions)
            %h6.mb-3 Subscription
            %hr.border-2.border-top
            %p
              Subscription status:
              %span.badge{ class: "badge-#{subscription_badge_class(subscription_status)}" }= subscription_status || 'no subscription'
            - if @brand.subscription&.running?
              = button_tag 'Update Payment Details', class: 'btn btn-primary', id: 'update-subscription'
              = button_tag 'Cancel Subscription', class: 'btn btn-primary', id: 'cancel-subscription'
            - else
              = button_tag 'Buy Subscription', class: 'btn btn-primary', id: 'buy-subscription'
= content_for :custom_javascript do
  - if Rails.application.config.x.paddle.vendor_id
    %script{ src: 'https://cdn.paddle.com/paddle/paddle.js' }
    :javascript
      Paddle.Setup({ vendor: #{Rails.application.config.x.paddle.vendor_id} })
    -# rubocop:disable Style/IdenticalConditionalBranches
    - if @brand.subscription&.running?
      :javascript
        function cancelSubscription() {
          Paddle.Checkout.open({
            override: "#{@brand.subscription.cancel_url}", success: "#{checkout_redirect_path}"
          })
        }
        function updateSubscription() {
          Paddle.Checkout.open({
            override: "#{@brand.subscription.update_url}", success: "#{checkout_redirect_path}"
          })
        }
        document.getElementById('cancel-subscription').addEventListener('click', cancelSubscription, false)
        document.getElementById('update-subscription').addEventListener('click', updateSubscription, false)
    - else
      :javascript
        function buySubscription() {
          Paddle.Checkout.open({
            product: 592438, allowQuantity: false, quantity: "#{@brand.users.count}",
            passthrough: "{\"brand_id\": #{@brand.id}}", success: "#{checkout_redirect_path}"
          })
        }
        document.getElementById('buy-subscription').addEventListener('click', buySubscription, false)
    -# rubocop:enable Style/IdenticalConditionalBranches
